<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" alarm">
<title>Setting Alarm | Pinpoint APM</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-black.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="pinpoint" href="http://localhost:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> <img src="./images/logo2.png"> </span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="https://github.com/naver/pinpoint" target="_blank">GitHub</a></li>
                
                
                
                <li><a href="news">News</a></li>
                
                
                
                <li><a href="resources">Pinpoint Blogs</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:roy.kim@navercorp.com?subject=pinpoint feedback&body=If it\'s an issue please check QnA page in the homepage or Pinpoint GitHub repository https://github.com/naver/pinpoint/issues' "><i class="fa fa-envelope-o"></i> Feedback</a>

</li>

		
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Setting Alarm">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->

<div class="container">

  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                <script language="javascript" type="text/javascript">
    $(document).ready(function () {
        //GetLatestReleaseInfo();
        GetVersionInfo();
    });

    // function GetLatestReleaseInfo() {
    //     $.getJSON("https://api.github.com/repos/naver/pinpoint/releases").done(function (json) {
    //         var release = json[0];
    //         var version = release.tag_name;
    //         document.getElementById("version").innerHTML = version;
    //     });
    // }

    function GetVersionInfo() {

        var pathname = window.location.pathname;
        var path = pathname.slice(10,15);
        var versioned = true;
        var tempNum1 = path.slice(0,1);
        var tempNum2 = path.slice(2,3);
        var tempNum3 = path.slice(4,5);

        if($.isEmptyObject(path)){
            versioned = false;
        }else{
            if(isNaN(tempNum1) || isNaN(tempNum2) && isNaN(tempNum3)){
                versioned = false;
            }
        }

        $.getJSON("version.json").done(function (data){

            $.each(data, function(key, value) {

                if(versioned && path == value.ver){
                    $('#selbox').append('<option selected="selected" value="'+ value.url +'">'+ value.ver +'</option>');
                }else{
                    $('#selbox').append($('<option>', {
                        value: value.url,
                        text : value.ver
                    }));
                }
            })
        });
    }
</script>




<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">
        <tr>
            <td>
                Pinpoint222
            </td>
            <td>
                <select id="selbox" name="ver" onchange="document.location.href=this.value">
                </select>
            </td>
        </tr>
    </li>
    <tr></tr>
    <tr> <td><iframe src="https://ghbtns.com/github-btn.html?user=naver&repo=pinpoint&type=star&count=true" frameborder="0" scrolling="0" width="110px" height="20px"></iframe>
    <iframe src="https://ghbtns.com/github-btn.html?user=naver&repo=pinpoint&type=fork&count=true" frameborder="0" scrolling="0" width="110px" height="20px"></iframe>
    </td> </tr>
  
  
  

    
      
  

    
    <li>
        
        <li><a href="index.html">Home</a></li>
        
    </li>
    
      
  
  <li>
      <a href="#">Pinpoint</a>
      <ul>
          
          
          
          <li><a href="overview.html">Overview</a></li>
          
          
          
          
          
          
          <li><a href="history.html">History</a></li>
          
          
          
          
          
          
          <li><a href="techdetail.html">Technical Details</a></li>
          
          
          
          
          
          
          <li><a href="additionalplugins.html">Additional Plugins</a></li>
          
          
          
          
      </ul>
   </li>
    

    
      
  
  <li>
      <a href="#">Getting Started</a>
      <ul>
          
          
          
          <li><a href="quickstart.html">QuickStart</a></li>
          
          
          
          
          
          
          <li><a href="installation.html">Installation</a></li>
          
          
          
          
          
          
          <li><a href="docker.html">Install with Docker</a></li>
          
          
          
          
          
          
          <li><a href="troubleshooting_network.html">TrobleShooting(Network)</a></li>
          
          
          
          
      </ul>
   </li>
    

    
      
  
  <li>
      <a href="#">Documents</a>
      <ul>
          
          
          
          <li><a href="plugindevguide.html">Plugin Developer Guide</a></li>
          
          
          
          
          
          
          <li class="active"><a href="alarm.html">Setting Alarms</a></li>
          
          
          
          
          
          
          <li><a href="applicationinspector.html">How to use Application Inspector</a></li>
          
          
          
          
          
          
          <li><a href="perrequestfeatureguide.html">Per Request Features</a></li>
          
          
          
          
          
          
          <li><a href="httpstatuscodefailure.html">HTTP Status Code Failure(config)</a></li>
          
          
          
          
          
          
          <li><a href="proxyhttpheader.html">Proxy HTTP Header(config)</a></li>
          
          
          
          
      </ul>
   </li>
    

    
      
  
  <li>
      <a href="#">Contribution</a>
      <ul>
          
          
          
          <li><a href="contribution.html">Readme</a></li>
          
          
          
          
          
          
          <li><a href="https://github.com/naver/pinpoint/labels/proposal" target="_blank">Help Wanted</a></li>
          
          
          
          
      </ul>
   </li>
    

    
      
  

    
    <li>
        
        <li><a href="https://twitter.com/Pinpoint_APM" target="_blank">Twitter</a></li>
        
    </li>
    
      
  

    
    <li>
        
        <li><a href="https://github.com/naver/pinpoint/releases" target="_blank">Release Notes</a></li>
        
    </li>
    
      
  

    
    <li>
        
        <li><a href="faq.html">FAQ</a></li>
        
    </li>
    
      
  

    
    <li>
        
        <li><a href="pinpointinaction.html">Powered by Pinpoint</a></li>
        
    </li>
    
      
  

    
    <li>
        
        <li><a href="https://github.com/naver/pinpoint/issues" target="_blank">Questions and answers</a></li>
        
    </li>
    
      
  

    
    <li>
        
        <li><a href="https://github.com/naver/pinpoint" target="_blank">Fork me at Github</a></li>
        
    </li>
    
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <a no_icon href="https://github.com/naver/pinpoint"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
            <div class="post-header">
   <h1 class="post-title-main">Setting Alarm</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    


    

  <p><a href="#alarm">English</a> | <a href="#alarm-1">한글</a></p>
<h1 id="alarm">Alarm</h1>

<p>Pinpoint-web periodically checks the applications’ status and triggers an alarm if certain pre-configured conditions (rules) are met.</p>

<p>These conditions are (by default) checked every 3 minutes by a background batch process within the Web module, using the last 5 minutes of data. Once a condition is met, the batch process sends an sms/email to users registered to a user group.</p>

<h2 id="1-user-guide">1. User Guide</h2>

<p>1) Configuration menu
<img src="images/alarm/alarm_figure01.gif" alt="alarm_figure01.gif" /></p>

<p>2) Registering users
<img src="images/alarm/alarm_figure02.gif" alt="alarm_figure02.gif" /></p>

<p>3) Creating user groups
<img src="images/alarm/alarm_figure03.gif" alt="alarm_figure03.gif" /></p>

<p>4) Adding users to user group
<img src="images/alarm/alarm_figure04.gif" alt="alarm_figure04.gif" /></p>

<p>5) Setting alarm rules
<img src="images/alarm/alarm_figure05.gif" alt="alarm_figure05.gif" /></p>

<p><strong>Alarm Rules</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SLOW COUNT
   Triggered when the number of slow requests sent by the application exceeds the configured threshold.

SLOW RATE
   Triggered when the percentage(%) of slow requests sent by the application exceeds the configured threshold.

ERROR COUNT
   Triggered when the number of failed requests sent by the application exceeds the configured threshold.

ERROR RATE
   Triggered when the percentage(%) of failed requests sent by the application exceeds the configured threshold.

TOTAL COUNT
   Triggered when the number of all requests sent by the application exceeds the configured threshold.

SLOW COUNT TO CALLEE
   Triggered when the number of slow requests sent to the application exceeds the configured threshold.

SLOW RATE TO CALLEE
   Triggered when the percentage(%) of slow requests sent to the application exceeds the configured threshold.

ERROR COUNT TO CALLEE
   Triggered when the number of failed requests sent to the application exceeds the configured threshold.

ERROR RATE TO CALLEE
   Triggered when the percentage(%) of failed requests sent to the application exceeds the configured threshold.

TOTAL COUNT TO CALLEE
   Triggered when the number of all requests sent to the application exceeds the configured threshold.

HEAP USAGE RATE
   Triggered when the application's heap usage(%) exceeds the configured threshold.

JVM CPU USAGE RATE
   Triggered when the application's CPU usage(%) exceeds the configured threshold.

DATASOURCE CONNECTION USAGE RATE
   Triggered when the application's DataSource connection usage(%) exceeds the configured threshold.
</code></pre></div></div>

<h2 id="2-implementation--configuration">2. Implementation &amp; Configuration</h2>

<p>In order to use the alarm function, you must implement your own logic to send sms and email by implementing <code class="highlighter-rouge">com.navercorp.pinpoint.web.alarm.AlarmMessageSender</code> and registering it as a Spring managed bean. When an alarm is triggered, <code class="highlighter-rouge">AlarmMessageSender#sendEmail</code>, and <code class="highlighter-rouge">AlarmMessageSender#sendSms</code> methods are called.</p>

<blockquote>
  <p>If an email/sms is sent everytime when a threshold is exceeded, we felt that alarm message would be spammable.<br />
Therefore we decided to gradually increase the transmission frequency for alarms.<br />
ex) If an alarm occurs continuously, transmission frequency is increased by a factor of two. 3 min -&gt; 6min -&gt; 12min -&gt; 24min</p>
</blockquote>

<h3 id="1-implementing-alarmmessagesender-and-spring-bean-registration">1) Implementing <code class="highlighter-rouge">AlarmMessageSender</code> and Spring bean registration</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class AlarmMessageSenderImple implements AlarmMessageSender {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    @Autowired
    private UserGroupService userGroupService;
    
    @Override
    public void sendSms(AlarmChecker checker, int sequenceCount) {
        List&lt;String&gt; receivers = userGroupService.selectPhoneNumberOfMember(checker.getUserGroupId());

        if (receivers.size() == 0) {
            return;
        }

        for (String message : checker.getSmsMessage()) {
            logger.info("send SMS : {}", message);

            // TODO Implement logic for sending SMS
        }
    }

    @Override
    public void sendEmail(AlarmChecker checker, int sequenceCount) {
        List&lt;String&gt; receivers = userGroupService.selectEmailOfMember(checker.getUserGroupId());

        if (receivers.size() == 0) {
            return;
        }

        for (String message : checker.getEmailMessage()) {
            logger.info("send email : {}", message);

            // TODO Implement logic for sending email
        }
    }
}
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;bean id="AlarmMessageSenderImple" class="com.navercorp.pinpoint.web.alarm.AlarmMessageSenderImple"/&gt;
</code></pre></div></div>

<h3 id="2-configuring-batch-properties">2) Configuring batch properties</h3>
<p>Set <code class="highlighter-rouge">batch.enable</code> flag to <strong>true</strong> in <em>batch.properties</em></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batch.enable=true
</code></pre></div></div>

<p><code class="highlighter-rouge">batch.server.ip</code> configuration is there to prevent concurrent batch operations when there are multiple pinpoint web servers. The batch is executed only if the server’s IP address is identical to the value set in <code class="highlighter-rouge">batch.server.ip</code>. (Setting this to 127.0.0.1 will start the batch in all the web servers)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batch.server.ip=X.X.X.X
</code></pre></div></div>

<h3 id="3-configuring-mysql">3) Configuring MYSQL</h3>
<p>Set up a MYSQL server and configure connection information in <em>jdbc.properties</em> file.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jdbc.driverClassName=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:13306/pinpoint?characterEncoding=UTF-8
jdbc.username=admin
jdbc.password=admin
</code></pre></div></div>
<p>Create tables by running <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/sql/CreateTableStatement-mysql.sql">CreateTableStatement-mysql.sql</a></em>, and <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/sql/SpringBatchJobRepositorySchema-mysql.sql">SpringBatchJobRepositorySchema-mysql.sql</a></em>.</p>

<h3 id="4-others">4) Others</h3>
<p><strong>1) You may start the alarm batch in a separate process</strong> - Simply start the spring batch job using the <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-alarmJob.xml">applicationContext-alarmJob.xml</a></em> file inside the Pinpoint-web module.</p>

<p><strong>2) You may change the batch execution period by modifying the cron expression in <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-batch-schedule.xml">applicationContext-batch-schedule.xml</a></em> file</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;task:scheduled-tasks scheduler="scheduler"&gt;
    &lt;task:scheduled ref="batchJobLauncher" method="alarmJob" cron="0 0/3 * * * *" /&gt;
&lt;/task:scheduled-tasks&gt;
</code></pre></div></div>

<p><strong>3) Ways to improve alarm batch performance</strong> - The alarm batch was designed to run concurrently. If you have a lot of applications with alarms registered, you may increase the size of the executor’s thread pool by modifying <code class="highlighter-rouge">pool-size</code> in <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-batch.xml">applicationContext-batch.xml</a></em> file.</p>

<p>Note that increasing this value will result in higher resource usage.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;task:executor id="poolTaskExecutorForPartition" pool-size="1" /&gt;
</code></pre></div></div>

<p>If there are a lot of alarms registered to applications, you may set the <code class="highlighter-rouge">alarmStep</code> registered in <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-batch.xml">applicationContext-batch.xml</a></em> file to run concurrently.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;step id="alarmStep" xmlns="http://www.springframework.org/schema/batch"&gt;
    &lt;tasklet task-executor="poolTaskExecutorForStep" throttle-limit="3"&gt;
        &lt;chunk reader="reader" processor="processor" writer="writer" commit-interval="1"/&gt;
    &lt;/tasklet&gt;
&lt;/step&gt;
&lt;task:executor id="poolTaskExecutorForStep" pool-size="10" /&gt;
</code></pre></div></div>

<p><strong>4) use quickstart’s web</strong> - 
Pinpoint Web uses Mysql to persist users, user groups, and alarm configurations.<br />
However Quickstart uses MockDAO to reduce memory usage.<br />
Therefore if you want to use Mysql for Quickstart, please refer to Pinpoint Web’s <a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/applicationContext-dao-config.xml">applicationContext-dao-config.xml</a>, <a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/jdbc.properties">jdbc.properties</a>.</p>

<hr />

<h1 id="alarm-1">Alarm</h1>

<p>pinpoint-web 서버에서 application 상태를 주기적으로 체크하여 application 상태의 수치가 임계치를 초과할 경우 사용자에게 알람을 전송하는 기능을 제공한다.</p>

<p>application 상태 값이 사용자가 설정한 임계치를 초과하는 지 판단하는 batch는 pinpoint-web 서버내에서 background로 동작 된다.
alarm batch는 기본적으로 3분에 한번씩 동작이 된다. 최근 5분동안의 데이터를 수집해서 alarm 조건을 만족하면 user group에 속한 user 들에게 sms /email을 전송한다.</p>

<h2 id="1-alarm-기능-사용-방법">1. Alarm 기능 사용 방법</h2>

<p>1) 설정 화면으로 이동
<img src="images/alarm/alarm_figure01.gif" alt="alarm_figure01.gif" />
2) user를 등록 
<img src="images/alarm/alarm_figure02.gif" alt="alarm_figure02.gif" />
3) userGroup을 생성
<img src="images/alarm/alarm_figure03.gif" alt="alarm_figure03.gif" />
4) userGroup에 member를 등록
<img src="images/alarm/alarm_figure04.gif" alt="alarm_figure04.gif" />
5) alarm rule을 등록 
<img src="images/alarm/alarm_figure05.gif" alt="alarm_figure05.gif" /></p>

<p>alarm rule에 대한 설명은 아래를 참고하시오.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SLOW COUNT
   application 내에서 외부서버를 호출한 요청 중 slow 호출의 개수가 임계치를 초과한 경우 알람이 전송된다.
    
SLOW RATE
   application 내에서 외부서버를 호출한 요청 중 slow 호출의 비율(%)이 임계치를 초과한 경우 알람이 전송된다.

ERROR COUNT
   application 내에서 외부서버를 호출한 요청 중 error 가 발생한 호출의 개수가 임계치를 초과한 경우 알람이 전송된다.

ERROR RATE
   application 내에서 외부서버를 호출한 요청 중 error 가 발생한 호출의 비율이 임계치를 초과한 경우 알람이 전송된다.

TOTAL COUNT
   application 내에서 외부서버를 호출한 요청의 개수가 임계치를 초과한 경우 알람이 전송된다.

SLOW COUNT TO CALLEE
   외부에서 application을 호출한 요청 중에 외부서버로 응답을 늦게 준 요청의 개수가 임계치를 초과한 경우 알람이 전송된다.

SLOW RATE TO CALLEE
   외부에서 application을 호출한 요청 중에 외부서버로 응답을 늦게 준 요청의 비율(%)이 임계치를 초과한 경우 알람이 전송된다.

ERROR COUNT TO CALLEE
   외부에서 application을 호출한 요청 중에 에러가 발생한 요청의 개수가 임계치를 초과한 경우 알람이 전송된다.

ERROR RATE TO CALLEE
   외부에서 application을 호출한 요청 중에 에러가 발생한 요청의 비율(%)이 임계치를 초과한 경우 알람이 전송된다.

TOTAL COUNT TO CALLEE
   외부에서 application을 호출한 요청 개수가 임계치를 초과한 경우 알람이 전송된다.

HEAP USAGE RATE
   heap의 사용률이 임계치를 초과한 경우 알람이 전송된다.

JVM CPU USAGE RATE
   applicaiton의 CPU 사용률이 임계치를 초과한 경우 알람이 전송된다.

DATASOURCE CONNECTION USAGE RATE
   applicaiton의 DataSource내의 Connection 사용률이 임계치를 초과한 경우 알람이 전송된다.
</code></pre></div></div>

<h2 id="2-구현-및-설정-방법">2. 구현 및 설정 방법</h2>

<p>알람 기능을 사용하기 위해서는 sms, email을 전송하는 로직을 직접 구현해야 한다.
pipoint-web에서 제공하는 <code class="highlighter-rouge">com.navercorp.pinpoint.web.alarm.AlarmMessageSender</code> interface를 구현하고 spring framework의 bean으로 등록하면 된다.
사용자가 등록한 alarm rule 중 임계치를 초과한 rule이 발생하면 AlarmMessageSender의 sendEmail, sendSms 함수가 호출이 된다.
구현 및 설정 방법은 아래와 같다.</p>

<blockquote>
  <p>연속적으로 알람 조건이 임게치를 초과한 경우에 매번 sms/email를 전송하지 않습니다.<br />
알람 조건이 만족할때마다 매번 sms/email이 전송되는것은 오히려 방해가 된다고 생각하기 때문입니다. 그래서 연속해서 알람이 발생할 경우 sms/email 전송 주기가 점증적으로 증가됩니다.<br />
예) 알람이 연속해서 발생할 경우, 전송 주기는 3분 -&gt; 6분 -&gt; 12분 -&gt; 24분 으로 증가합니다.</p>
</blockquote>

<h3 id="1-alarmmessagesender-구현-및-bean-등록">1) AlarmMessageSender 구현 및 bean 등록</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class AlarmMessageSenderImple implements AlarmMessageSender {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    @Autowired
    private UserGroupService userGroupService;

    @Override
    public void sendSms(AlarmChecker checker, int sequenceCount) {
        List&lt;String&gt; receivers = userGroupService.selectPhoneNumberOfMember(checker.getUserGroupId());

        if (receivers.size() == 0) {
            return;
        }

        for (String message : checker.getSmsMessage()) {
            logger.info("send SMS : {}", message);

            //TODO sms 전송 로직 구현
        }
    }

    @Override
    public void sendEmail(AlarmChecker checker, int sequenceCount) {
        List&lt;String&gt; receivers = userGroupService.selectEmailOfMember(checker.getUserGroupId());

        if (receivers.size() == 0) {
            return;
        }

        for (String message : checker.getEmailMessage()) {
            logger.info("send email : {}", message);

            //TODO email 전송 로직 구현
        }
    }
}
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;bean id="AlarmMessageSenderImple" class="com.navercorp.pinpoint.web.alarm.AlarmMessageSenderImple"/&gt;
</code></pre></div></div>

<h3 id="2-batch-properties-설정">2) batch properties 설정</h3>

<p>batch.properties 설정 파일에 batch.enable 값을 true로 설정한다.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batch.enable=true 
</code></pre></div></div>

<p>pinpoint web서버가 2대 이상일 경우에 동일한 batch가 여러대의 서버에서 동시에 실행되는것을 방지하기 위한 기능이다.
batch.properties 파일에 설정한 ip의 값과 pinpoint-web 서버의 ip가 일치할 경우에만 batch가 동작이 된다.
(127.0.0.1을 설정한 경우 모든 pinpoint web에서 batch가 동작 된다.)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batch.server.ip=X.X.X.X

</code></pre></div></div>

<h3 id="3-mysql-서버-ip-주소-설정--table-생성">3) MYSQL 서버 IP 주소 설정 &amp; table 생성</h3>
<p>Mysql 서버를 준비하고 jdbc.properties 파일에 접속 정보를 설정한다.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jdbc.driverClassName=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:13306/pinpoint?characterEncoding=UTF-8
jdbc.username=admin
jdbc.password=admin
</code></pre></div></div>
<p>필요한 table 생성 - <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/sql/CreateTableStatement-mysql.sql">CreateTableStatement-mysql.sql</a></em>, <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/sql/SpringBatchJobRepositorySchema-mysql.sql">SpringBatchJobReositorySchema-mysql.sql</a></em></p>

<h2 id="3-기타">3. 기타</h2>
<p><strong>1) alarm batch를 별도 프로세스로 실행하는 것도 가능하다.</strong>
pinpoint-web 프로젝트의 <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-alarmJob.xml">applicationContext-alarmJob.xml</a></em> 파일을 이용해서 spring batch job을 실행하면 된다.
실행 방법은 대한 구체적인 방법은 spirng batch 메뉴얼을 참고하자.</p>

<p><strong>2) batch의 동작 주기를 조정하고 싶다면 <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-batch-schedule.xml">applicationContext-batch-schedule.xml</a></em> 파일의 cron expression을 수정하면 된다.</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;task:scheduled-tasks scheduler="scheduler"&gt;
    &lt;task:scheduled ref="batchJobLauncher" method="alarmJob" cron="0 0/3 * * * *" /&gt;
&lt;/task:scheduled-tasks&gt;
</code></pre></div></div>

<p><strong>3) alarm batch 성능을 높이는 방법은 다음과 같다.</strong>
alarm batch 성능 튜닝을 위해서 병렬로 동작이 가능하도록 구현을 해놨다.
그래서 아래에서 언급된 조건에 해당하는 경우 설정값을 조정한다면 성능을 향상 시킬수 있다. 단 병렬성을 높이면 리소스의 사용률이 높아지는것은 감안해야한다.</p>

<p>alarm이 등록된 application의 개수가 많다면 <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-batch.xml">applicationContext-batch.xml</a></em> 파일의 poolTaskExecutorForPartition의 pool size를 늘려주면 된다.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;task:executor id="poolTaskExecutorForPartition" pool-size="1" /&gt;
</code></pre></div></div>

<p>application 각각마다 등록된 alarm의 개수가 많다면 <em><a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/batch/applicationContext-batch.xml">applicationContext-batch.xml</a></em> 파일에 선언된 alarmStep이 병렬로 동작되도록 설정하면 된다.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;step id="alarmStep" xmlns="http://www.springframework.org/schema/batch"&gt;
    &lt;tasklet task-executor="poolTaskExecutorForStep" throttle-limit="3"&gt;
        &lt;chunk reader="reader" processor="processor" writer="writer" commit-interval="1"/&gt;
    &lt;/tasklet&gt;
&lt;/step&gt;
&lt;task:executor id="poolTaskExecutorForStep" pool-size="10" /&gt;
</code></pre></div></div>

<p><strong>4) quickstart web을 사용한다면.</strong>
pinpoint web은 mockDAO를 사용하기 때문에 pinpont web의 설정들을 참고해서 기능을 사용해야한다.
<a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/applicationContext-dao-config.xml">applicationContext-dao-config.xml
</a>, <a href="https://github.com/naver/pinpoint/blob/master/web/src/main/resources/jdbc.properties">jdbc.properties</a>.</p>


    <div class="tags">
        
    </div>

</div>




<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = "http://localhost:4000/pinpoint/alarm.html";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = "alarm.html"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');

        s.src = 'https://pinpoint-home-page.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2018 Naver. All rights reserved. <br />
<span>Page last updated:</span> Feb 1, 2018<br/>

<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

<!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-57786344-4','auto');ga('require','displayfeatures');ga('send','pageview');</script>


</html>
